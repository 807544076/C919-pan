# C919-Pan

<del>本仓库为 C919 密码学小学期项目`中传放心传`的<strong>代码仓库</strong></del>

本仓库为前项目`中传放心传`迁移而来，目前由本人独自完善升级

**感谢之前组员的努力和老师的教导。**

参与人员：
* oceanfish
* <del>ReA
* <del>GuiGuiGui
* <del>JiaJia
* <del>nian-gao
* <del>vol

## 进度 & Todo
### Update Record

--------- 3.27 ---------
* 完成初步文件 aes 加密上传后端解密，密钥通过 rsa 加密传输

--------- 3.28 ---------
* 完全实现文件 aes 加密上传后解密，密钥通过 rsa 加密传输，修复了3.27日的 bug

--------- 3.30 ---------
* 完成了文件后端的独立aes加密存储

--------- 4.02 ---------
* 完成了 index 界面的文件显示，上传，删除功能

### Todo:
* 测试aes加密存储，为下载做准备
* 测试 flask 异步处理功能，优化操作速度
* 完成快速上传设计并实装
* （maybe）设计一个消息推送系统

## 设计

### 上传文件：

**当前设计：**

* 网页端生成随机 key 和 iv，文件内容通过 AES.OFB 模式加密，同时从后端获取 server 公钥，对 key 和 iv 进行加密，一起传输回后端。在后端用 server 私钥解密 key 和 iv，再解密文件内容。

* 单独文件单独aes密钥存储，密钥用 user 公私钥对加密
bytes -> hex string

* 文件信息添加 stamp 字段用于标识加密文件的aes密钥

* 通过 stamp 字段为每个文件生成单独的信息和下载界面，提供加密文件，文件签名和 hash 值下载，通过 `/?file=xxx&owner=xxx` 实现（理论）

* 对匿名用户和非所有者（已登录）提供加密后文件下载，非所有者（已登录）可以通过授权码获得解密文件，或文件所有者设置为共享后，可以为非所有者（已登录）提供解密后文件。

* 每个授权码有时间限制，超时后需要重新生成，提供联系文件所有者邮箱功能，允许发送一条邮件给所有者，邮件内容限定，并且

* 快速上传需要解密已有文件并复制到新上传者处重新加密，添加新的记录（或许有更好的方法）

**下一步设计：**
* HMAC 与 rsa 签名实现
* 消息系统

## 任务目标

- 基于网页的用户注册与登录系统
  - [ ] 使用https绑定证书到域名而非IP地址 【 *PKI* *X.509* 】
  - [x] 允许用户注册到系统 
    - 用户名的合法字符集范围：中文、英文字母、数字
    - 类似：-、_、.等合法字符集范围之外的字符不允许使用
    - 用户口令长度限制在36个字符之内
    - 对用户输入的口令进行强度校验，禁止使用弱口令
  - [x] 使用合法用户名和口令登录系统 
  - [x] 禁止使用明文存储用户口令 ： 
    ​	PBKDF2
    ​	散列算法
    ​	慢速散列
    ​	针对散列算法（如MD5、SHA1等）的攻击方法
    - 存储的口令即使被公开，也无法还原/解码出原始明文口令
  - [x] （可选）安全的忘记口令 / 找回密码功能 
  - [ ] （可选）微信/微博/支付宝的OAuth授权登录 / 注册绑定 
  - [ ] （可选）双因素认证 
    - OTP: Google Authenticator
    - Email
    - SMS
    - 扫码登录
- 基于网页的文件上传加密与数字签名系统
  - [ ] 已完成《基于网页的用户注册与登录系统》所有要求
  - [x] 限制文件大小：小于 10MB
  - [x] 限制文件类型：office文档、常见图片类型
  - [x] 匿名用户禁止上传文件
  - [x] 对文件进行对称加密存储到文件系统，禁止明文存储文件 【 *对称加密* *密钥管理（如何安全存储对称加密密钥）* *对称加密密文的PADDING问题* 】
  - [ ] 系统对加密后文件进行数字签名 【 *数字签名（多种签名工作模式差异）* 】
  - [x] （可选）文件秒传：服务器上已有的文件，客户端可以不必再重复上传了

- 基于网页的加密文件下载与解密

  - [ ] 已完成《基于网页的文件上传加密与数字签名系统》所有要求
  - [ ] 提供匿名用户加密后文件和关联的数字签名文件的下载
    - 客户端对下载后的文件进行数字签名验证 【 *非对称（公钥）加密* *数字签名* 】
    - 客户端对下载后的文件可以解密还原到原始文件 【 *对称解密* *密钥管理* 】
  - [ ] 提供已登录用户解密后文件下载
  - [ ] 下载URL设置有效期（限制时间或限制下载次数），过期后禁止访问 【 *数字签名* *消息认证码* *Hash Extension Length Attack* *Hash算法与HMAC算法的区别与联系* 】
  - [ ] 提供静态文件的散列值下载，供下载文件完成后本地校验文件完整性 【 *散列算法* 】


## 参考资料
[如何设计一个消息中心](https://juejin.cn/post/7140651064725864485)